name: CI and Deploy

on:
  push:
    branches: [main] # Only run this workflow on merge/push to main

jobs:
  # This job is optional â€” see note below
  check-merge-source:
    name: Prevent direct merge to main (DEV only)
    runs-on: ubuntu-latest

    steps:
      - name: Fail if main commit not from dev
        run: |
          echo "Checking merge source..."
          # Get the branch that triggered the push
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          # When committing directly to main (not merge), abort
          if [[ "${{ github.head_ref }}" == "main" ]]; then
            echo "Push directly to main detected."
            echo "Use pull requests from dev branch only."
            exit 1
          fi
          echo "Merge source OK."

  ci:
    name: CI & Deploy to Render
    runs-on: ubuntu-latest
    needs: check-merge-source

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 22.16.0

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # - name: Build
      #   run: yarn build

      - name: Deploy to Render
        env:
          DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "Triggering Render Deploy..."
          curl -X POST "$DEPLOY_HOOK_URL"
